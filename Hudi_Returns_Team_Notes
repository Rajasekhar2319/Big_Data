Overview
How to get started - Using spark-shell CLI
How to get started

spark-shell \
--packages org.apache.hudi:hudi-spark-bundle_2.12:0.9.0,org.apache.spark:spark-avro_2.12:2.4.7,org.apache.avro:avro:1.8.2 \
--conf "spark.serializer=org.apache.spark.serializer.KryoSerializer" \
--conf 'spark.sql.extensions=org.apache.spark.sql.hudi.HoodieSparkSessionExtension' \
--conf "spark.sql.hive.convertMetastoreParquet=false"
 
import org.apache.spark.sql.SaveMode._
import org.apache.hudi.DataSourceWriteOptions._
import org.apache.hudi.DataSourceWriteOptions
import org.apache.hudi.DataSourceReadOptions._
import org.apache.hudi.DataSourceReadOptions
import org.apache.hudi.QuickstartUtils._
import org.apache.spark.sql.DataFrame


pom dependency

<dependency>
    <groupId>org.apache.hudi</groupId>
    <artifactId>hudi-spark-bundle_2.12</artifactId>
    <version>0.9.0</version>
</dependency>


How to query hudi table using beeline terminal
Note: Mandatory properties to be executed before creating/querying HUDI table from beeline 


add jar  gs://5bd4184dae2be32bb32c2e85019ed0db9d401d238571add0bbe29fa7b0157f/raw/hoodie-hadoop-mr-bundle-0.4.4.jar;
set hive.input.format= org.apache.hudi.hadoop.HoodieParquetInputFormat;
set hive.tez.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;


Sample HUDI table creation using beeline 

CREATE EXTERNAL TABLE stg_wmt_ww_fin_rtn_mb_dl_secure.SLR_CONFIG_POC(
 `_hoodie_commit_time` STRING
,`_hoodie_commit_seqno` STRING
,`_hoodie_record_key` STRING
,`_hoodie_partition_path` STRING
,`_hoodie_file_name` STRING
,`CONFIG_PLCY_TYPE_NM`  STRING 
,`PROD_HRCHY_TMPL_NM`   STRING 
,`PROD_HRCHY_TMPL_VAL`  STRING 
,`ATTR_NM`  STRING 
,`ATTR_VAL` STRING 
,`EFF_END_TS`   STRING 
,`ACTV_IND` STRING 
,`UPD_TS`   STRING 
,`CRE_USER` STRING 
,`CRE_TS`   STRING 
,`UPD_USER` STRING 
,`OP_CMPNY_CD`  STRING 
,`GEO_REGION_CD`    STRING 
,`SRC_RCV_TS`   STRING 
,`TENANT_ORG_ID`    STRING 
,`EFF_START_TS` STRING 
,`SLR_ORG_ID`   STRING 
,`OFFR_KEY` STRING
) PARTITIONED BY (CRE_DT STRING)
 ROW FORMAT SERDE 'org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe'
 STORED AS INPUTFORMAT
 'com.uber.hoodie.hadoop.HoodieInputFormat'
 OUTPUTFORMAT 'org.apache.hadoop.hive.ql.io.parquet.MapredParquetOutputFormat'
  LOCATION 'gs://950c9f02a16a88138930efe39d0aa87c64d2948b5d55ee35c780c2369717f7/stg_wmt_ww_fin_rtn_mb_dl_secure/SLR_CONFIG_POC';




Use Cases covered
Insert data in hudi table 

def upsert(df: DataFrame, tableName: String, key: String, combineKey: String) = {
  val path="gs://950c9f02a16a88138930efe39d0aa87c64d2948b5d55ee35c780c2369717f7/stg_wmt_ww_fin_rtn_mb_dl_secure/CLAIM_PARQUET_TEST2"
 
  val srcSchema="stg_wmt_ww_fin_rtn_mb_dl_secure"
 
   df.write.format("org.apache.hudi")
    .option(TABLE_TYPE_OPT_KEY, "COPY_ON_WRITE")
    .option(RECORDKEY_FIELD_OPT_KEY, key)
    .option(PRECOMBINE_FIELD_OPT_KEY, combineKey)
    .option("hoodie.table.name",tableName)
    .option(DataSourceWriteOptions.HIVE_DATABASE_OPT_KEY, srcSchema)
    .option(DataSourceWriteOptions.HIVE_TABLE_OPT_KEY, tableName)
    .option(DataSourceWriteOptions.HIVE_STYLE_PARTITIONING_OPT_KEY, "true")
    .option(DataSourceWriteOptions.HIVE_PARTITION_FIELDS_OPT_KEY, "part_col")
    .option(OPERATION_OPT_KEY, UPSERT_OPERATION_OPT_VAL)
    .mode(Overwrite)
    .save(s"$path")
}


Update data in hudi table

  def upsert(df: DataFrame, tableName: String, key: String, combineKey: String) = {
    val path="gs://950c9f02a16a88138930efe39d0aa87c64d2948b5d55ee35c780c2369717f7/stg_wmt_ww_fin_rtn_mb_dl_secure/CLAIM_PARQUET_TEST2"
 
    val srcSchema="stg_wmt_ww_fin_rtn_mb_dl_secure"
 
     df.write.format("org.apache.hudi")
      .option(TABLE_TYPE_OPT_KEY, "COPY_ON_WRITE")
      .option(RECORDKEY_FIELD_OPT_KEY, key)
      .option(PRECOMBINE_FIELD_OPT_KEY, combineKey)
      .option("hoodie.table.name",tableName)
      .option(DataSourceWriteOptions.HIVE_DATABASE_OPT_KEY, srcSchema)
      .option(DataSourceWriteOptions.HIVE_TABLE_OPT_KEY, tableName)
      .option(DataSourceWriteOptions.HIVE_STYLE_PARTITIONING_OPT_KEY, "true")
      .option(DataSourceWriteOptions.HIVE_PARTITION_FIELDS_OPT_KEY, "part_col")
      .option(OPERATION_OPT_KEY, UPSERT_OPERATION_OPT_VAL)
      .mode(Append)
      .save(s"$path")
  }###################### FUNCTION CALLING #####################
upsert(srcDfClaim,"CLAIM_PARQUET_TEST2","WM_CLAIM_ID","CLAIM_CRE_TS")


Delete data in hudi table 

 def deleteData(df: DataFrame, tableName: String, key: String, combineKey: String) = {
    val path="gs://950c9f02a16a88138930efe39d0aa87c64d2948b5d55ee35c780c2369717f7/stg_wmt_ww_fin_rtn_mb_dl_secure/CLAIM_PARQUET_TEST2"
  
    val srcSchema="stg_wmt_ww_fin_rtn_mb_dl_secure"
  
    df.write.format("org.apache.hudi").
      options(getQuickstartWriteConfigs).
      option(PRECOMBINE_FIELD_OPT_KEY, combineKey).
      option(RECORDKEY_FIELD_OPT_KEY, key).
      option(PARTITIONPATH_FIELD_OPT_KEY, "part_col").
      option(DataSourceWriteOptions.HIVE_DATABASE_OPT_KEY, srcSchema).
      option(DataSourceWriteOptions.HIVE_TABLE_OPT_KEY, tableName).
      option(DataSourceWriteOptions.HIVE_STYLE_PARTITIONING_OPT_KEY, "true").
      option(DataSourceWriteOptions.HIVE_PARTITION_FIELDS_OPT_KEY, "part_col").
      option("hoodie.table.name", tableName).
      option(OPERATION_OPT_KEY,"delete").
      mode(Append).
      save(s"$path")
  }
###################### FUNCTION CALLING #####################
val df = spark.read.format("org.apache.hudi").load("gs://950c9f02a16a88138930efe39d0aa87c64d2948b5d55ee35c780c2369717f7/stg_wmt_ww_fin_rtn_mb_dl_secure/CLAIM_PARQUET_TEST2")
df.show()
df.createOrReplaceTempView("Claims_table")
val deleteDf=spark.sql("select * from Claims_table where trk_num in ('546568935667')")
deleteDf.show
deleteData(deleteDf,"CLAIM_PARQUET_TEST2","WM_CLAIM_ID","CLAIM_CRE_TS")
Reference links for delete:
https://cwiki.apache.org/confluence/display/HUDI/2020/01/15/Delete+support+in+Hudi
https://hudi.apache.org/docs/writing_data/#deletes




Incremental reads :
We have followed steps from HUDI page for performing incremental reads, below is the link for reference 
https://hudi.apache.org/docs/0.8.0/quick-start-guide/#incremental-query

Below properties were used to time travel the data :


set hoodie.hudi_trips_cow.consume.max.commits=2;
set hoodie.hudi_trips_cow.consume.start.timestamp=0;
select * from hudi_trips_cow ;
Note:
set hoodie.hudi_trips_cow.consume.max.commits=4;
We can set different values for above property and get the data for older commits.
If we do not set any commit related properties mentioned above, by default we will get only the snapshot(latest) version of the data and not the history data.


SCD type 2 implementation using custom logic 

Create table statements used :

CREATE EXTERNAL TABLE stg_wmt_ww_fin_rtn_mb_dl_secure.SLR_CONFIG_POC(
 `_hoodie_commit_time` STRING
,`_hoodie_commit_seqno` STRING
,`_hoodie_record_key` STRING
,`_hoodie_partition_path` STRING
,`_hoodie_file_name` STRING
,`CONFIG_PLCY_TYPE_NM`  STRING 
,`PROD_HRCHY_TMPL_NM`   STRING 
,`PROD_HRCHY_TMPL_VAL`  STRING 
,`ATTR_NM`  STRING 
,`ATTR_VAL` STRING 
,`EFF_END_TS`   STRING 
,`ACTV_IND` STRING 
,`UPD_TS`   STRING 
,`CRE_USER` STRING 
,`CRE_TS`   STRING 
,`UPD_USER` STRING 
,`OP_CMPNY_CD`  STRING 
,`GEO_REGION_CD`    STRING 
,`SRC_RCV_TS`   STRING 
,`TENANT_ORG_ID`    STRING 
,`EFF_START_TS` STRING 
,`SLR_ORG_ID`   STRING 
,`OFFR_KEY` STRING
) PARTITIONED BY (CRE_DT STRING)
 ROW FORMAT SERDE 'org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe'
 STORED AS INPUTFORMAT
 'com.uber.hoodie.hadoop.HoodieInputFormat'
 OUTPUTFORMAT 'org.apache.hadoop.hive.ql.io.parquet.MapredParquetOutputFormat'
  LOCATION 'gs://950c9f02a16a88138930efe39d0aa87c64d2948b5d55ee35c780c2369717f7/stg_wmt_ww_fin_rtn_mb_dl_secure/SLR_CONFIG_POC';
 
CREATE EXTERNAL TABLE `raw_wmt_ww_fin_rtn_mb_dl_secure.raw_slr_config_poc`(
`CONFIG_PLCY_TYPE_NM`   STRING 
,`PROD_HRCHY_TMPL_NM`   STRING 
,`PROD_HRCHY_TMPL_VAL`  STRING 
,`ATTR_NM`  STRING 
,`ATTR_VAL` STRING 
,`EFF_END_TS`   STRING 
,`ACTV_IND` STRING 
,`UPD_TS`   STRING 
,`CRE_USER` STRING 
,`CRE_TS`   STRING 
,`UPD_USER` STRING 
,`OP_CMPNY_CD`  STRING 
,`GEO_REGION_CD`    STRING 
,`SRC_RCV_TS`   STRING 
,`TENANT_ORG_ID`    STRING 
,`EFF_START_TS` STRING 
,`SLR_ORG_ID`   STRING 
,`OFFR_KEY` STRING
,`CRE_DT` STRING)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY ',' 
STORED AS INPUTFORMAT
  'org.apache.hadoop.mapred.TextInputFormat'
OUTPUTFORMAT
  'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'
LOCATION
  'gs://5bd4184dae2be32bb32c2e85019ed0db9d401d238571add0bbe29fa7b0157f/raw_wmt_ww_fin_rtn_mb_dl_secure/raw_slr_config_poc'
 
 
CREATE EXTERNAL TABLE `stg_wmt_ww_fin_rtn_mb_dl_secure.STG_RCP_SLR_CONFIG_POC`(
martid  STRING     
,producername   STRING     
,sellerid   STRING     
,`timestamp`    STRING     
,configtype STRING     
,keytemplate    STRING     
,policykey  STRING     
,name   STRING     
,value  STRING     
,change_ind STRING     
,cre_user   STRING     
,cre_ts STRING     
,raw_cre_dt STRING     
)ROW FORMAT DELIMITED
FIELDS TERMINATED BY ',' 
STORED AS INPUTFORMAT
  'org.apache.hadoop.mapred.TextInputFormat'
OUTPUTFORMAT
  'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'
LOCATION
  'gs://950c9f02a16a88138930efe39d0aa87c64d2948b5d55ee35c780c2369717f7/stg_wmt_ww_fin_rtn_mb_dl_secure.db/STG_RCP_SLR_CONFIG_POC';




Sample code implementing SCD2 logic:
Approach 1 (with delete operation)

spark-shell \
--packages org.apache.hudi:hudi-spark-bundle_2.12:0.9.0,org.apache.spark:spark-avro_2.12:2.4.7,org.apache.avro:avro:1.8.2 \
--conf "spark.serializer=org.apache.spark.serializer.KryoSerializer" \
--conf 'spark.sql.extensions=org.apache.spark.sql.hudi.HoodieSparkSessionExtension' \
--conf "spark.sql.hive.convertMetastoreParquet=false"
 
import org.apache.spark.sql.SaveMode._
import org.apache.hudi.DataSourceWriteOptions._
import org.apache.hudi.DataSourceWriteOptions
import org.apache.hudi.DataSourceReadOptions._
import org.apache.hudi.DataSourceReadOptions
import org.apache.hudi.QuickstartUtils._
import org.apache.spark.sql.DataFrame
 
 
#################################### STEP - 1 ################################################
##first time data insert into target HUDI table :
val srcDf = spark.sql("select * from raw_wmt_ww_fin_rtn_mb_dl_secure.raw_slr_config_poc")
       
srcDf.write.format("org.apache.hudi").
  option(TABLE_TYPE_OPT_KEY, "COPY_ON_WRITE").
  option("hoodie.datasource.write.keygenerator.class","org.apache.hudi.keygen.ComplexKeyGenerator").
  option(RECORDKEY_FIELD_OPT_KEY, "slr_org_id ,config_plcy_type_nm,prod_hrchy_tmpl_nm,prod_hrchy_tmpl_val,attr_nm,attr_val,eff_end_ts").
  option("hoodie.datasource.hive_sync.support_timestamp","true").
  option(PRECOMBINE_FIELD_OPT_KEY, "eff_start_ts") .option("hoodie.table.name","SLR_CONFIG_POC").
  option(DataSourceWriteOptions.HIVE_DATABASE_OPT_KEY, "stg_wmt_ww_fin_rtn_mb_dl_secure").
  option(DataSourceWriteOptions.HIVE_TABLE_OPT_KEY, "SLR_CONFIG_POC").
  option(OPERATION_OPT_KEY, UPSERT_OPERATION_OPT_VAL).
  option(DataSourceWriteOptions.HIVE_STYLE_PARTITIONING_OPT_KEY, "true").
  option(PARTITIONPATH_FIELD_OPT_KEY, "cre_dt").
  mode(Append).
  save(s"gs://950c9f02a16a88138930efe39d0aa87c64d2948b5d55ee35c780c2369717f7/stg_wmt_ww_fin_rtn_mb_dl_secure/SLR_CONFIG_POC")
 
#################################### STEP - 2 ################################################
# Loading HUDI table data into Dataframe
 
val SlrConfig = spark.read.format("org.apache.hudi").load("gs://950c9f02a16a88138930efe39d0aa87c64d2948b5d55ee35c780c2369717f7/stg_wmt_ww_fin_rtn_mb_dl_secure/SLR_CONFIG_POC")
 
SlrConfig.show(false)
+-------------------+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+-------------------------------------------------------------------------+-------------------+------------------+-------------------+-----------------+--------+-------------------+--------+------+-----------------+-------------------+--------+-----------+-------------+----------+-------------+-------------------+----------+--------------------------------+----------+
|_hoodie_commit_time|_hoodie_commit_seqno|_hoodie_record_key                                                                                                                                                                                    |_hoodie_partition_path|_hoodie_file_name                                                        |config_plcy_type_nm|prod_hrchy_tmpl_nm|prod_hrchy_tmpl_val|attr_nm          |attr_val|eff_end_ts         |actv_ind|upd_ts|cre_user         |cre_ts             |upd_user|op_cmpny_cd|geo_region_cd|src_rcv_ts|tenant_org_id|eff_start_ts       |slr_org_id|offr_key                        |cre_dt    |
+-------------------+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+-------------------------------------------------------------------------+-------------------+------------------+-------------------+-----------------+--------+-------------------+--------+------+-----------------+-------------------+--------+-----------+-------------+----------+-------------+-------------------+----------+--------------------------------+----------+
|20220203095545     |20220203095545_8_3  |slr_org_id:101053954,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:AA,eff_end_ts:9999-12-31 15:59:59|cre_dt=2021-07-02     |86669e64-af65-4b0e-a7cb-c1e19fd6c0af-0_8-193-39582_20220203095545.parquet|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |returnCenterAlias|AA      |9999-12-31 15:59:59|1       |      |RCP-BULK-OVERRIDE|2021-07-02 01:05:02|        |           |             |          |4571         |2021-07-02 03:07:59|101053954 |861685C0AE8A4BFB95B23269E805A64D|2021-07-02|
|20220203095545     |20220203095545_6_3  |slr_org_id:101043447,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:GG,eff_end_ts:9999-12-31 15:59:59|cre_dt=2021-10-31     |b9a1a256-616e-46b6-9d02-0a5bfdfacaaf-0_6-193-39580_20220203095545.parquet|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |returnCenterAlias|GG      |9999-12-31 15:59:59|1       |      |RCP-BULK-OVERRIDE|2021-10-31 01:05:28|        |           |             |          |4571         |2021-10-30 08:27:52|101043447 |9983664A4435459AA9266999FF57A15E|2021-10-31|
|20220203095545     |20220203095545_1_1  |slr_org_id:101087560,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:gt,eff_end_ts:9999-12-31 15:59:59|cre_dt=2022-01-28     |6ddc6f77-dcdf-409f-bb63-1c0ce82b7775-0_1-187-39575_20220203095545.parquet|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |returnCenterAlias|gt      |9999-12-31 15:59:59|1       |      |RCP-BULK-OVERRIDE|2022-01-28 01:06:42|        |           |             |          |4571         |2022-01-27 08:58:57|101087560 |2593B38B567149A2AC03451174392353|2022-01-28|
|20220203095545     |20220203095545_5_1  |slr_org_id:101072853,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:GT,eff_end_ts:9999-12-31 15:59:59|cre_dt=2021-12-28     |d5581eb6-a332-4bff-9d5c-a7258d21c56e-0_5-193-39579_20220203095545.parquet|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |returnCenterAlias|GT      |9999-12-31 15:59:59|1       |      |RCP-BULK-OVERRIDE|2021-12-28 01:05:16|        |           |             |          |4571         |2021-12-27 11:36:41|101072853 |C313F674D039460CAB128108252C5B9E|2021-12-28|
|20220203095545     |20220203095545_0_1  |slr_org_id:101043490,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:GT,eff_end_ts:9999-12-31 15:59:59|cre_dt=2021-05-06     |93161ed7-238b-473f-94ac-c4c912050a21-0_0-181-39574_20220203095545.parquet|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |returnCenterAlias|GT      |9999-12-31 15:59:59|1       |      |RCP-BULK-OVERRIDE|2021-05-06 00:32:45|        |           |             |          |4571         |2020-10-30 07:56:41|101043490 |516457803CCD4F769C6109903831B9BA|2021-05-06|
|20220203095545     |20220203095545_4_2  |slr_org_id:101087594,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:GT,eff_end_ts:9999-12-31 15:59:59|cre_dt=2021-12-29     |dd11605a-445a-4d99-b236-b5f2f0db9751-0_4-187-39578_20220203095545.parquet|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |returnCenterAlias|GT      |9999-12-31 15:59:59|1       |      |RCP-BULK-OVERRIDE|2021-12-29 01:05:23|        |           |             |          |4571         |2021-12-28 07:31:44|101087594 |C58F5E0CCC9B4867B8A3D92BD9446835|2021-12-29|
|20220203095545     |20220203095545_7_1  |slr_org_id:101044619,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:GG,eff_end_ts:9999-12-31 15:59:59|cre_dt=2021-11-10     |a5a6b6a9-8cff-40dc-ae21-ce12213e69d7-0_7-193-39581_20220203095545.parquet|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |returnCenterAlias|GG      |9999-12-31 15:59:59|1       |      |RCP-BULK-OVERRIDE|2021-11-10 01:05:55|        |           |             |          |4571         |2021-11-09 10:00:22|101044619 |798A19DA29FB4584B956305FDC37E319|2021-11-10|
|20220203095545     |20220203095545_2_2  |slr_org_id:2605,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:F,eff_end_ts:9999-12-31 15:59:59      |cre_dt=2021-08-20     |e29833b5-b704-458f-ba8a-d9d89cab6cd8-0_2-187-39576_20220203095545.parquet|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |returnCenterAlias|F       |9999-12-31 15:59:59|1       |      |RCP-BULK-OVERRIDE|2021-08-20 01:08:54|        |           |             |          |4571         |2021-08-19 15:58:20|2605      |199104919BC7408D878C598554A65348|2021-08-20|
|20220203095545     |20220203095545_3_1  |slr_org_id:339,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:MO,eff_end_ts:9999-12-31 15:59:59      |cre_dt=2019-06-11     |66ce2752-1d00-4f77-8187-1bff5ff10527-0_3-187-39577_20220203095545.parquet|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |returnCenterAlias|MO      |9999-12-31 15:59:59|1       |      |RCP-BULK-OVERRIDE|2019-06-11 11:23:14|        |           |             |          |4571         |2018-11-12 11:43:29|339       |DAF856738A63423592A3CD4A544115EA|2019-06-11|
|20220203095545     |20220203095545_3_2  |slr_org_id:2354,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:shippingFee,attr_val:99,eff_end_ts:9999-12-31 15:59:59           |cre_dt=2019-06-11     |66ce2752-1d00-4f77-8187-1bff5ff10527-0_3-187-39577_20220203095545.parquet|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |shippingFee      |99      |9999-12-31 15:59:59|1       |      |RCP-BULK-OVERRIDE|2019-06-11 11:22:29|        |           |             |          |4571         |2018-10-31 18:23:01|2354      |0FAF8812717F4289B5D2ACE9AC4E207B|2019-06-11|
+-------------------+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+-------------------------------------------------------------------------+-------------------+------------------+-------------------+-----------------+--------+-------------------+--------+------+-----------------+-------------------+--------+-----------+-------------+----------+-------------+-------------------+----------+--------------------------------+----------+
 
SlrConfig.createOrReplaceTempView("SlrConfig")
 
 
#################################### STEP - 3 ################################################
# Record present in raw but not in target table, Fresh record dataframe
 
val newRecDf=spark.sql("""select
    config_plcy_type_nm
    ,prod_hrchy_tmpl_nm
    ,prod_hrchy_tmpl_val
    ,attr_nm
    ,attr_val
    , eff_start_ts
    ,eff_end_ts
    ,actv_ind
    ,tenant_org_id
    ,slr_org_id
    ,offr_key
    ,src_rcv_ts
    ,cre_user
    ,cre_ts
    ,cre_dt
    ,upd_ts
    ,upd_user
    ,op_cmpny_cd
    ,geo_region_cd from
    (select
     stg.configtype     as config_plcy_type_nm
    ,stg.keytemplate   as prod_hrchy_tmpl_nm
    ,stg.policykey  as prod_hrchy_tmpl_val
    ,stg.name       as attr_nm
    ,stg.value     as attr_val
    ,stg.timestamp as eff_start_ts
    ,'9999-12-31 23:59:59' as eff_end_ts
    ,'1'  as actv_ind
    ,'4571' as tenant_org_id
    ,stg.sellerid as slr_org_id
    ,'Category' as offr_key
    ,stg.timestamp as src_rcv_ts
    ,stg.cre_user
    ,stg.cre_ts as cre_ts
    ,cast(cast(cast(stg.cre_ts as timestamp) as date) as string) cre_dt
    ,row_number() over(partition by stg. sellerid ,stg.configtype ,stg.keytemplate ,stg.policykey,stg.name  order by timestamp desc) row_num
    ,'' as upd_ts
    ,'' as upd_user
    ,'' as op_cmpny_cd
    ,'' as geo_region_cd
    from  stg_wmt_ww_fin_rtn_mb_dl_secure.stg_rcp_slr_config_poc stg
    left outer join slrconfig tgt
    on  cast( stg.sellerid as integer)  = cast(tgt.slr_org_id as integer)
    and stg.configtype  = tgt.config_plcy_type_nm
    and stg.keytemplate =  tgt.prod_hrchy_tmpl_nm
    and stg.policykey  = tgt.prod_hrchy_tmpl_val
    and stg.name = tgt.attr_nm
    and tgt. actv_ind =1 and tgt.offr_key  ='Category'
    where change_ind ='I' and coalesce(martid,'1') = '0' and tgt.slr_org_id is null 
    and  cast(stg.sellerid as integer) is not null) src
    where row_num=1""")
 
newRecDf.show(false)
+-------------------+------------------+-------------------+-----------+--------+-------------------+-------------------+--------+-------------+----------+--------+-------------------+-----------------+-------------------+----------+------+--------+-----------+-------------+
|config_plcy_type_nm|prod_hrchy_tmpl_nm|prod_hrchy_tmpl_val|attr_nm    |attr_val|eff_start_ts       |eff_end_ts         |actv_ind|tenant_org_id|slr_org_id|offr_key|src_rcv_ts         |cre_user         |cre_ts             |cre_dt    |upd_ts|upd_user|op_cmpny_cd|geo_region_cd|
+-------------------+------------------+-------------------+-----------+--------+-------------------+-------------------+--------+-------------+----------+--------+-------------------+-----------------+-------------------+----------+------+--------+-----------+-------------+
|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |shippingFee|99      |2022-01-27 08:17:11|9999-12-31 23:59:59|1       |4571         |9999      |Category|2022-01-27 08:17:11|RCP-BULK-OVERRIDE|2022-02-01 18:21:11|2022-02-01|      |        |           |             |
+-------------------+------------------+-------------------+-----------+--------+-------------------+-------------------+--------+-------------+----------+--------+-------------------+-----------------+-------------------+----------+------+--------+-----------+-------------+
 
 
 
#################################### STEP - 4 ################################################
# inner join to fetch the records present in target and source/raw table
 
val innerJoinDf=spark.sql("""
      SELECT * from (
      SELECT
       stg.configtype     as stg_config_plcy_type_nm
      ,stg.keytemplate   as stg_prod_hrchy_tmpl_nm
      ,stg.policykey  as stg_prod_hrchy_tmpl_val
      ,stg.name       as stg_attr_nm
      ,stg.value     as stg_attr_val
      ,stg.timestamp as stg_eff_start_ts
      ,stg.sellerid as stg_slr_org_id
      ,stg.cre_user as stg_cre_user
      ,stg.cre_ts as stg_cre_ts
 
      ,tgt.config_plcy_type_nm  as tgt_config_plcy_type_nm
      ,tgt.prod_hrchy_tmpl_nm as tgt_prod_hrchy_tmpl_nm
      ,tgt.prod_hrchy_tmpl_val as tgt_prod_hrchy_tmpl_val
      ,tgt.attr_nm as tgt_attr_nm
      ,tgt.attr_val as tgt_attr_val
      ,tgt.eff_start_ts as tgt_eff_start_ts
      ,tgt.eff_end_ts as tgt_eff_end_ts
      ,tgt.slr_org_id as tgt_slr_org_id
      ,tgt.cre_user as tgt_cre_user
      ,tgt.cre_ts as tgt_cre_ts
 
      ,row_number() over(partition by stg. sellerid ,stg.configtype ,stg.keytemplate ,stg.policykey,stg.name,stg.value order by stg.timestamp desc) row_num
      from  stg_wmt_ww_fin_rtn_mb_dl_secure.stg_rcp_slr_config_poc stg
      inner join slrconfig tgt
      on cast( stg.sellerid as integer)  = cast(tgt.slr_org_id as integer)
      and stg.configtype  = tgt.config_plcy_type_nm
      and stg.keytemplate =  tgt.prod_hrchy_tmpl_nm
      and stg.policykey  = tgt.prod_hrchy_tmpl_val
      and stg.name  = tgt.attr_nm
      and tgt. actv_ind = 1 /* and  tgt.offr_key  ='Category' */
      where stg.change_ind ='U' and coalesce(stg.martid,'1') = '0' 
      and  cast ( stg.`timestamp` as timestamp) >  cast(tgt.eff_start_ts as timestamp)
      and  cast(stg.sellerid as integer) is not null)
      where row_num=1""")
 
innerJoinDf.show(false)
+-----------------------+----------------------+-----------------------+-----------------+------------+-------------------+--------------+-----------------+-------------------+-----------------------+----------------------+-----------------------+-----------------+------------+-------------------+--------------+-----------------+-------------------+-------+
|stg_config_plcy_type_nm|stg_prod_hrchy_tmpl_nm|stg_prod_hrchy_tmpl_val|stg_attr_nm      |stg_attr_val|stg_eff_start_ts   |stg_slr_org_id|stg_cre_user     |stg_cre_ts         |tgt_config_plcy_type_nm|tgt_prod_hrchy_tmpl_nm|tgt_prod_hrchy_tmpl_val|tgt_attr_nm      |tgt_attr_val|tgt_eff_start_ts   |tgt_slr_org_id|tgt_cre_user     |tgt_cre_ts         |row_num|
+-----------------------+----------------------+-----------------------+-----------------+------------+-------------------+--------------+-----------------+-------------------+-----------------------+----------------------+-----------------------+-----------------+------------+-------------------+--------------+-----------------+-------------------+-------+
|RETURN_POLICY          |RCP-BULK-OVERRIDE     |RCP-BULK-OVERRIDE      |returnCenterAlias|12          |2022-02-02 15:58:20|2605          |RCP-BULK-OVERRIDE|2021-08-20 01:08:54|RETURN_POLICY          |RCP-BULK-OVERRIDE     |RCP-BULK-OVERRIDE      |returnCenterAlias|F           |2021-08-19 15:58:20|2605          |RCP-BULK-OVERRIDE|2021-08-20 01:08:54|1      |
|RETURN_POLICY          |RCP-BULK-OVERRIDE     |RCP-BULK-OVERRIDE      |shippingFee      |24          |2020-02-02 18:23:01|2354          |RCP-BULK-OVERRIDE|2019-06-11 11:22:29|RETURN_POLICY          |RCP-BULK-OVERRIDE     |RCP-BULK-OVERRIDE      |shippingFee      |99          |2018-10-31 18:23:01|2354          |RCP-BULK-OVERRIDE|2019-06-11 11:22:29|1      |
+-----------------------+----------------------+-----------------------+-----------------+------------+-------------------+--------------+-----------------+-------------------+-----------------------+----------------------+-----------------------+-----------------+------------+-------------------+--------------+-----------------+-------------------+-------+
 
 
innerJoinDf.createOrReplaceTempView("updateRecordTable")
 
 
 
#################################### STEP - 5 ################################################
# creating a df of updated record with one 'Active' and other 'Inactive' indicator using the same temoprary table created in above step
 
val updActiveRecDf=spark.sql(""" 
     SELECT
       stg_config_plcy_type_nm as config_plcy_type_nm
      ,stg_prod_hrchy_tmpl_nm as prod_hrchy_tmpl_nm
      ,stg_prod_hrchy_tmpl_val as prod_hrchy_tmpl_val
      ,stg_attr_nm as attr_nm
      ,stg_attr_val as attr_val
      ,stg_eff_start_ts as eff_start_ts
      ,'9999-12-31 23:59:59' as eff_end_ts
      ,'1'  as actv_ind
      , '4571' as tenant_org_id
      ,stg_slr_org_id as slr_org_id
      ,'Category' as offr_key
      ,stg_eff_start_ts as src_rcv_ts
      ,stg_cre_user as cre_user
      ,stg_cre_ts as cre_ts
      ,cast(cast(cast(stg_cre_ts as timestamp) as date) as string) cre_dt
      ,stg_cre_ts as upd_ts
      ,stg_cre_user as upd_user
      ,'' as op_cmpny_cd
      ,'' as geo_region_cd
     from updaterecordtable""")
 
updActiveRecDf.show(false)
+-------------------+------------------+-------------------+-----------------+--------+-------------------+-------------------+--------+-------------+----------+--------+-------------------+-----------------+-------------------+----------+-------------------+-----------------+-----------+-------------+
|config_plcy_type_nm|prod_hrchy_tmpl_nm|prod_hrchy_tmpl_val|attr_nm          |attr_val|eff_start_ts       |eff_end_ts         |actv_ind|tenant_org_id|slr_org_id|offr_key|src_rcv_ts         |cre_user         |cre_ts             |cre_dt    |upd_ts             |upd_user         |op_cmpny_cd|geo_region_cd|
+-------------------+------------------+-------------------+-----------------+--------+-------------------+-------------------+--------+-------------+----------+--------+-------------------+-----------------+-------------------+----------+-------------------+-----------------+-----------+-------------+
|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |returnCenterAlias|12      |2022-02-02 15:58:20|9999-12-31 23:59:59|1       |4571         |2605      |Category|2022-02-02 15:58:20|RCP-BULK-OVERRIDE|2021-08-20 01:08:54|2021-08-20|2021-08-20 01:08:54|RCP-BULK-OVERRIDE|           |             |
|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |shippingFee      |24      |2020-02-02 18:23:01|9999-12-31 23:59:59|1       |4571         |2354      |Category|2020-02-02 18:23:01|RCP-BULK-OVERRIDE|2019-06-11 11:22:29|2019-06-11|2019-06-11 11:22:29|RCP-BULK-OVERRIDE|           |             |
+-------------------+------------------+-------------------+-----------------+--------+-------------------+-------------------+--------+-------------+----------+--------+-------------------+-----------------+-------------------+----------+-------------------+-----------------+-----------+-------------+
 
 
val updInactiveRecDf=
spark.sql("""
     SELECT
       tgt_config_plcy_type_nm as config_plcy_type_nm
      ,tgt_prod_hrchy_tmpl_nm as prod_hrchy_tmpl_nm
      ,tgt_prod_hrchy_tmpl_val as prod_hrchy_tmpl_val
      ,tgt_attr_nm as attr_nm
      ,tgt_attr_val as attr_val
      ,tgt_eff_start_ts as eff_start_ts
      ,cast(cast(stg_eff_start_ts as timestamp) + interval -1 seconds as string) as eff_end_ts
      ,'0'  as actv_ind
      ,'4571' as tenant_org_id
      ,tgt_slr_org_id as slr_org_id
      ,'Category' as offr_key
      ,tgt_eff_start_ts as src_rcv_ts
      ,tgt_cre_user as cre_user
      ,tgt_cre_ts as cre_ts
      ,cast(cast(cast(tgt_cre_ts as timestamp) as date) as string) cre_dt
      ,stg_cre_ts as upd_ts
      ,stg_cre_user as upd_user
      ,'' as op_cmpny_cd
      ,'' as geo_region_cd
     from updaterecordtable""")
 
updInactiveRecDf.show(false)
+-------------------+------------------+-------------------+-----------------+--------+-------------------+-------------------+--------+-------------+----------+--------+-------------------+-----------------+-------------------+----------+-------------------+-----------------+-----------+-------------+
|config_plcy_type_nm|prod_hrchy_tmpl_nm|prod_hrchy_tmpl_val|attr_nm          |attr_val|eff_start_ts       |eff_end_ts         |actv_ind|tenant_org_id|slr_org_id|offr_key|src_rcv_ts         |cre_user         |cre_ts             |cre_dt    |upd_ts             |upd_user         |op_cmpny_cd|geo_region_cd|
+-------------------+------------------+-------------------+-----------------+--------+-------------------+-------------------+--------+-------------+----------+--------+-------------------+-----------------+-------------------+----------+-------------------+-----------------+-----------+-------------+
|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |returnCenterAlias|F       |2021-08-19 15:58:20|2022-02-02 15:58:19|0       |4571         |2605      |Category|2021-08-19 15:58:20|RCP-BULK-OVERRIDE|2021-08-20 01:08:54|2021-08-20|2021-08-20 01:08:54|RCP-BULK-OVERRIDE|           |             |
|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |shippingFee      |99      |2018-10-31 18:23:01|2020-02-02 18:23:00|0       |4571         |2354      |Category|2018-10-31 18:23:01|RCP-BULK-OVERRIDE|2019-06-11 11:22:29|2019-06-11|2019-06-11 11:22:29|RCP-BULK-OVERRIDE|           |             |
+-------------------+------------------+-------------------+-----------------+--------+-------------------+-------------------+--------+-------------+----------+--------+-------------------+-----------------+-------------------+----------+-------------------+-----------------+-----------+-------------+
 
 
#################################### STEP - 6 ################################################
# Union of Active, Inactive and fresh records inorder to insert them to the target table
 
val insUdpRec=newRecDf.union(updActiveRecDf).union(updInactiveRecDf)
 
 
insUdpRec.show(false)
+-------------------+------------------+-------------------+-----------------+--------+-------------------+-------------------+--------+-------------+----------+--------+-------------------+-----------------+-------------------+----------+-------------------+-----------------+-----------+-------------+
|config_plcy_type_nm|prod_hrchy_tmpl_nm|prod_hrchy_tmpl_val|attr_nm          |attr_val|eff_start_ts       |eff_end_ts         |actv_ind|tenant_org_id|slr_org_id|offr_key|src_rcv_ts         |cre_user         |cre_ts             |cre_dt    |upd_ts             |upd_user         |op_cmpny_cd|geo_region_cd|
+-------------------+------------------+-------------------+-----------------+--------+-------------------+-------------------+--------+-------------+----------+--------+-------------------+-----------------+-------------------+----------+-------------------+-----------------+-----------+-------------+
|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |shippingFee      |99      |2022-01-27 08:17:11|9999-12-31 23:59:59|1       |4571         |9999      |Category|2022-01-27 08:17:11|RCP-BULK-OVERRIDE|2022-02-01 18:21:11|2022-02-01|                   |                 |           |             |
|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |returnCenterAlias|12      |2022-02-02 15:58:20|9999-12-31 23:59:59|1       |4571         |2605      |Category|2022-02-02 15:58:20|RCP-BULK-OVERRIDE|2021-08-20 01:08:54|2021-08-20|2021-08-20 01:08:54|RCP-BULK-OVERRIDE|           |             |
|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |shippingFee      |24      |2020-02-02 18:23:01|9999-12-31 23:59:59|1       |4571         |2354      |Category|2020-02-02 18:23:01|RCP-BULK-OVERRIDE|2019-06-11 11:22:29|2019-06-11|2019-06-11 11:22:29|RCP-BULK-OVERRIDE|           |             |
|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |returnCenterAlias|F       |2021-08-19 15:58:20|2022-02-02 15:58:19|0       |4571         |2605      |Category|2021-08-19 15:58:20|RCP-BULK-OVERRIDE|2021-08-20 01:08:54|2021-08-20|2021-08-20 01:08:54|RCP-BULK-OVERRIDE|           |             |
|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |shippingFee      |99      |2018-10-31 18:23:01|2020-02-02 18:23:00|0       |4571         |2354      |Category|2018-10-31 18:23:01|RCP-BULK-OVERRIDE|2019-06-11 11:22:29|2019-06-11|2019-06-11 11:22:29|RCP-BULK-OVERRIDE|           |             |
+-------------------+------------------+-------------------+-----------------+--------+-------------------+-------------------+--------+-------------+----------+--------+-------------------+-----------------+-------------------+----------+-------------------+-----------------+-----------+-------------+
 
 
#################################### STEP - 7 ################################################
# Writing data obtained from above step to target Hudi table
 
    insUdpRec.write.format("org.apache.hudi").
    option(TABLE_TYPE_OPT_KEY, "COPY_ON_WRITE").
    option("hoodie.datasource.write.keygenerator.class","org.apache.hudi.keygen.ComplexKeyGenerator").
    option(RECORDKEY_FIELD_OPT_KEY, "slr_org_id ,config_plcy_type_nm,prod_hrchy_tmpl_nm,prod_hrchy_tmpl_val,attr_nm,attr_val,eff_end_ts").
    option(PRECOMBINE_FIELD_OPT_KEY, "eff_start_ts") .option("hoodie.table.name","SLR_CONFIG_POC").
    option(DataSourceWriteOptions.HIVE_DATABASE_OPT_KEY, "stg_wmt_ww_fin_rtn_mb_dl_secure").
    option(DataSourceWriteOptions.HIVE_TABLE_OPT_KEY, "SLR_CONFIG_POC") .option(OPERATION_OPT_KEY, UPSERT_OPERATION_OPT_VAL).
    option(DataSourceWriteOptions.HIVE_STYLE_PARTITIONING_OPT_KEY, "true").option(PARTITIONPATH_FIELD_OPT_KEY, "cre_dt").
    mode(Append).
    save(s"gs://950c9f02a16a88138930efe39d0aa87c64d2948b5d55ee35c780c2369717f7/stg_wmt_ww_fin_rtn_mb_dl_secure/SLR_CONFIG_POC")
 
+-------------------------------------+--------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------+---------------------------------------------------------------------------+-------------------------------------+------------------------------------+-------------------------------------+-------------------------+--------------------------+----------------------------+--------------------------+------------------------+--------------------------+------------------------+--------------------------+-----------------------------+-------------------------------+----------------------------+-------------------------------+------------------------------+----------------------------+-----------------------------------+------------------------+
| slr_config_poc._hoodie_commit_time  | slr_config_poc._hoodie_commit_seqno  |         slr_config_poc._hoodie_record_key                                                                                                                                                              | slr_config_poc._hoodie_partition_path  |          slr_config_poc._hoodie_file_name                                 | slr_config_poc.config_plcy_type_nm  | slr_config_poc.prod_hrchy_tmpl_nm  | slr_config_poc.prod_hrchy_tmpl_val  | slr_config_poc.attr_nm  | slr_config_poc.attr_val  | slr_config_poc.eff_end_ts  | slr_config_poc.actv_ind  | slr_config_poc.upd_ts  | slr_config_poc.cre_user  | slr_config_poc.cre_ts  | slr_config_poc.upd_user  | slr_config_poc.op_cmpny_cd  | slr_config_poc.geo_region_cd  | slr_config_poc.src_rcv_ts  | slr_config_poc.tenant_org_id  | slr_config_poc.eff_start_ts  | slr_config_poc.slr_org_id  |      slr_config_poc.offr_key      | slr_config_poc.cre_dt  |
+-------------------------------------+--------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------+---------------------------------------------------------------------------+-------------------------------------+------------------------------------+-------------------------------------+-------------------------+--------------------------+----------------------------+--------------------------+------------------------+--------------------------+------------------------+--------------------------+-----------------------------+-------------------------------+----------------------------+-------------------------------+------------------------------+----------------------------+-----------------------------------+------------------------+
| 20220203101320                      | 20220203101320_8_1                   | slr_org_id:101053954,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:AA,eff_end_ts:9999-12-31 15:59:59 | cre_dt=2021-07-02                      | 056a1a8b-cb8c-4e8b-84da-ef54e398576c-0_8-189-26832_20220203101320.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | returnCenterAlias       | AA                       | 9999-12-31 15:59:59        | 1                        |                        | RCP-BULK-OVERRIDE        | 2021-07-02 01:05:02    |                          |                             |                               |                            | 4571                          | 2021-07-02 03:07:59          | 101053954                  | 861685C0AE8A4BFB95B23269E805A64D  | 2021-07-02             |
| 20220203101320                      | 20220203101320_6_1                   | slr_org_id:101043447,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:GG,eff_end_ts:9999-12-31 15:59:59 | cre_dt=2021-10-31                      | 9c08d9d4-cc45-43b3-a090-f7f9dfc37ee9-0_6-189-26830_20220203101320.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | returnCenterAlias       | GG                       | 9999-12-31 15:59:59        | 1                        |                        | RCP-BULK-OVERRIDE        | 2021-10-31 01:05:28    |                          |                             |                               |                            | 4571                          | 2021-10-30 08:27:52          | 101043447                  | 9983664A4435459AA9266999FF57A15E  | 2021-10-31             |
| 20220203101320                      | 20220203101320_0_1                   | slr_org_id:101043490,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:GT,eff_end_ts:9999-12-31 15:59:59 | cre_dt=2021-05-06                      | 7d601557-4d09-493b-be62-e35502c586b6-0_0-177-26824_20220203101320.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | returnCenterAlias       | GT                       | 9999-12-31 15:59:59        | 1                        |                        | RCP-BULK-OVERRIDE        | 2021-05-06 00:32:45    |                          |                             |                               |                            | 4571                          | 2020-10-30 07:56:41          | 101043490                  | 516457803CCD4F769C6109903831B9BA  | 2021-05-06             |
| 20220203101320                      | 20220203101320_5_1                   | slr_org_id:101072853,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:GT,eff_end_ts:9999-12-31 15:59:59 | cre_dt=2021-12-28                      | 9a8b5aa9-67bd-4aed-8e6d-1a71d2def734-0_5-189-26829_20220203101320.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | returnCenterAlias       | GT                       | 9999-12-31 15:59:59        | 1                        |                        | RCP-BULK-OVERRIDE        | 2021-12-28 01:05:16    |                          |                             |                               |                            | 4571                          | 2021-12-27 11:36:41          | 101072853                  | C313F674D039460CAB128108252C5B9E  | 2021-12-28             |
| 20220203101320                      | 20220203101320_4_1                   | slr_org_id:101087594,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:GT,eff_end_ts:9999-12-31 15:59:59 | cre_dt=2021-12-29                      | f47c974a-aca2-4f2a-b290-cb9062157924-0_4-183-26828_20220203101320.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | returnCenterAlias       | GT                       | 9999-12-31 15:59:59        | 1                        |                        | RCP-BULK-OVERRIDE        | 2021-12-29 01:05:23    |                          |                             |                               |                            | 4571                          | 2021-12-28 07:31:44          | 101087594                  | C58F5E0CCC9B4867B8A3D92BD9446835  | 2021-12-29             |
| 20220203101320                      | 20220203101320_1_1                   | slr_org_id:101087560,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:gt,eff_end_ts:9999-12-31 15:59:59 | cre_dt=2022-01-28                      | 5efec7c2-5743-4897-b337-68eb5ee0dfbb-0_1-183-26825_20220203101320.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | returnCenterAlias       | gt                       | 9999-12-31 15:59:59        | 1                        |                        | RCP-BULK-OVERRIDE        | 2022-01-28 01:06:42    |                          |                             |                               |                            | 4571                          | 2022-01-27 08:58:57          | 101087560                  | 2593B38B567149A2AC03451174392353  | 2022-01-28             |
| 20220203101320                      | 20220203101320_7_1                   | slr_org_id:101044619,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:GG,eff_end_ts:9999-12-31 15:59:59 | cre_dt=2021-11-10                      | 839c2f39-4f58-451d-b542-95b8cbe96144-0_7-189-26831_20220203101320.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | returnCenterAlias       | GG                       | 9999-12-31 15:59:59        | 1                        |                        | RCP-BULK-OVERRIDE        | 2021-11-10 01:05:55    |                          |                             |                               |                            | 4571                          | 2021-11-09 10:00:22          | 101044619                  | 798A19DA29FB4584B956305FDC37E319  | 2021-11-10             |
| 20220203101633                      | 20220203101633_0_2                   | slr_org_id:9999,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:shippingFee,attr_val:99,eff_end_ts:9999-12-31 23:59:59            | cre_dt=2022-02-01                      | a9fa0383-dad8-46b5-9b9f-670d00449707-0_0-270-40364_20220203101633.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | shippingFee             | 99                       | 9999-12-31 23:59:59        | 1                        |                        | RCP-BULK-OVERRIDE        | 2022-02-01 18:21:11    |                          |                             |                               | 2022-01-27 08:17:11        | 4571                          | 2022-01-27 08:17:11          | 9999                       | Category                          | 2022-02-01             |
| 20220203101320                      | 20220203101320_3_1                   | slr_org_id:2354,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:shippingFee,attr_val:99,eff_end_ts:9999-12-31 15:59:59            | cre_dt=2019-06-11                      | 06596953-6dcc-4b9a-b03e-c8e64d5bb9e4-0_3-183-26827_20220203101320.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | shippingFee             | 99                       | 9999-12-31 15:59:59        | 1                        |                        | RCP-BULK-OVERRIDE        | 2019-06-11 11:22:29    |                          |                             |                               |                            | 4571                          | 2018-10-31 18:23:01          | 2354                       | 0FAF8812717F4289B5D2ACE9AC4E207B  | 2019-06-11             |
| 20220203101320                      | 20220203101320_3_2                   | slr_org_id:339,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:MO,eff_end_ts:9999-12-31 15:59:59       | cre_dt=2019-06-11                      | 06596953-6dcc-4b9a-b03e-c8e64d5bb9e4-0_3-183-26827_20220203101320.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | returnCenterAlias       | MO                       | 9999-12-31 15:59:59        | 1                        |                        | RCP-BULK-OVERRIDE        | 2019-06-11 11:23:14    |                          |                             |                               |                            | 4571                          | 2018-11-12 11:43:29          | 339                        | DAF856738A63423592A3CD4A544115EA  | 2019-06-11             |
| 20220203101633                      | 20220203101633_1_1                   | slr_org_id:2354,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:shippingFee,attr_val:24,eff_end_ts:9999-12-31 23:59:59            | cre_dt=2019-06-11                      | 06596953-6dcc-4b9a-b03e-c8e64d5bb9e4-0_1-279-40365_20220203101633.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | shippingFee             | 24                       | 9999-12-31 23:59:59        | 1                        | 2019-06-11 11:22:29    | RCP-BULK-OVERRIDE        | 2019-06-11 11:22:29    | RCP-BULK-OVERRIDE        |                             |                               | 2020-02-02 18:23:01        | 4571                          | 2020-02-02 18:23:01          | 2354                       | Category                          | 2019-06-11             |
| 20220203101633                      | 20220203101633_1_2                   | slr_org_id:2354,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:shippingFee,attr_val:99,eff_end_ts:2020-02-02 18:23:00            | cre_dt=2019-06-11                      | 06596953-6dcc-4b9a-b03e-c8e64d5bb9e4-0_1-279-40365_20220203101633.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | shippingFee             | 99                       | 2020-02-02 18:23:00        | 0                        | 2019-06-11 11:22:29    | RCP-BULK-OVERRIDE        | 2019-06-11 11:22:29    | RCP-BULK-OVERRIDE        |                             |                               | 2018-10-31 18:23:01        | 4571                          | 2018-10-31 18:23:01          | 2354                       | Category                          | 2019-06-11             |
| 20220203101320                      | 20220203101320_2_1                   | slr_org_id:2605,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:F,eff_end_ts:9999-12-31 15:59:59       | cre_dt=2021-08-20                      | d23bb86a-01ae-47c1-9e65-57383ef08a3d-0_2-183-26826_20220203101320.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | returnCenterAlias       | F                        | 9999-12-31 15:59:59        | 1                        |                        | RCP-BULK-OVERRIDE        | 2021-08-20 01:08:54    |                          |                             |                               |                            | 4571                          | 2021-08-19 15:58:20          | 2605                       | 199104919BC7408D878C598554A65348  | 2021-08-20             |
| 20220203101633                      | 20220203101633_2_1                   | slr_org_id:2605,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:F,eff_end_ts:2022-02-02 15:58:19       | cre_dt=2021-08-20                      | d23bb86a-01ae-47c1-9e65-57383ef08a3d-0_2-279-40366_20220203101633.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | returnCenterAlias       | F                        | 2022-02-02 15:58:19        | 0                        | 2021-08-20 01:08:54    | RCP-BULK-OVERRIDE        | 2021-08-20 01:08:54    | RCP-BULK-OVERRIDE        |                             |                               | 2021-08-19 15:58:20        | 4571                          | 2021-08-19 15:58:20          | 2605                       | Category                          | 2021-08-20             |
| 20220203101633                      | 20220203101633_2_2                   | slr_org_id:2605,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:12,eff_end_ts:9999-12-31 23:59:59      | cre_dt=2021-08-20                      | d23bb86a-01ae-47c1-9e65-57383ef08a3d-0_2-279-40366_20220203101633.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | returnCenterAlias       | 12                       | 9999-12-31 23:59:59        | 1                        | 2021-08-20 01:08:54    | RCP-BULK-OVERRIDE        | 2021-08-20 01:08:54    | RCP-BULK-OVERRIDE        |                             |                               | 2022-02-02 15:58:20        | 4571                          | 2022-02-02 15:58:20          | 2605                       | Category                          | 2021-08-20             |
+-------------------------------------+--------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------+---------------------------------------------------------------------------+-------------------------------------+------------------------------------+-------------------------------------+-------------------------+--------------------------+----------------------------+--------------------------+------------------------+--------------------------+------------------------+--------------------------+-----------------------------+-------------------------------+----------------------------+-------------------------------+------------------------------+----------------------------+-----------------------------------+------------------------+
 
 
#################################### STEP - 8 ################################################
# Creating df of records to be deleted from target table
 
 
val deleteDf=spark.sql("""select
      tgt_config_plcy_type_nm as config_plcy_type_nm
      ,tgt_prod_hrchy_tmpl_nm as prod_hrchy_tmpl_nm
      ,tgt_prod_hrchy_tmpl_val as prod_hrchy_tmpl_val
      ,tgt_attr_nm as attr_nm
      ,tgt_attr_val as attr_val
      ,tgt_eff_start_ts as eff_start_ts
      ,tgt_eff_end_ts as eff_end_ts
      ,tgt_slr_org_id as slr_org_id
      ,tgt_cre_user as cre_user
      ,tgt_cre_ts as cre_ts
      ,cast(cast(cast(tgt_cre_ts as timestamp) as date) as string) cre_dt
       from updaterecordtable""")
 
deleteDf.show(false)
+-------------------+------------------+-------------------+-----------------+--------+-------------------+-------------------+----------+-----------------+-------------------+----------+
|config_plcy_type_nm|prod_hrchy_tmpl_nm|prod_hrchy_tmpl_val|attr_nm          |attr_val|eff_start_ts       |eff_end_ts         |slr_org_id|cre_user         |cre_ts             |cre_dt    |
+-------------------+------------------+-------------------+-----------------+--------+-------------------+-------------------+----------+-----------------+-------------------+----------+
|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |returnCenterAlias|F       |2021-08-19 15:58:20|9999-12-31 15:59:59|2605      |RCP-BULK-OVERRIDE|2021-08-20 01:08:54|2021-08-20|
|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |shippingFee      |99      |2018-10-31 18:23:01|9999-12-31 15:59:59|2354      |RCP-BULK-OVERRIDE|2019-06-11 11:22:29|2019-06-11|
+-------------------+------------------+-------------------+-----------------+--------+-------------------+-------------------+----------+-----------------+-------------------+----------+
 
 
#################################### STEP - 9 ################################################
# Logic to delete the records
 
def deleteData(df: DataFrame, tableName: String, key: String, combineKey: String) = {
    val path="gs://950c9f02a16a88138930efe39d0aa87c64d2948b5d55ee35c780c2369717f7/stg_wmt_ww_fin_rtn_mb_dl_secure/SLR_CONFIG_POC"
  
    val srcSchema="stg_wmt_ww_fin_rtn_mb_dl_secure"
  
    df.write.format("org.apache.hudi").
      options(getQuickstartWriteConfigs).
      option("hoodie.datasource.write.keygenerator.class","org.apache.hudi.keygen.ComplexKeyGenerator").
      option(PRECOMBINE_FIELD_OPT_KEY, combineKey).
      option(RECORDKEY_FIELD_OPT_KEY, key).
      option(PARTITIONPATH_FIELD_OPT_KEY, "cre_dt").
      option(DataSourceWriteOptions.HIVE_DATABASE_OPT_KEY, srcSchema).
      option(DataSourceWriteOptions.HIVE_TABLE_OPT_KEY, tableName).
      option(DataSourceWriteOptions.HIVE_STYLE_PARTITIONING_OPT_KEY, "true").
      option(DataSourceWriteOptions.HIVE_PARTITION_FIELDS_OPT_KEY, "cre_dt").
      option("hoodie.table.name", tableName).
      option(OPERATION_OPT_KEY,"delete").
      mode(Append).
      save(s"$path")
  
     
  }
 
 
deleteData(deleteDf,"SLR_CONFIG_POC","slr_org_id ,config_plcy_type_nm,prod_hrchy_tmpl_nm,prod_hrchy_tmpl_val,attr_nm,attr_val,eff_end_ts","eff_start_ts")
+-------------------------------------+--------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------+---------------------------------------------------------------------------+-------------------------------------+------------------------------------+-------------------------------------+-------------------------+--------------------------+----------------------------+--------------------------+------------------------+--------------------------+------------------------+--------------------------+-----------------------------+-------------------------------+----------------------------+-------------------------------+------------------------------+----------------------------+-----------------------------------+------------------------+
| slr_config_poc._hoodie_commit_time  | slr_config_poc._hoodie_commit_seqno  |         slr_config_poc._hoodie_record_key                                                                                                                                                              | slr_config_poc._hoodie_partition_path  |          slr_config_poc._hoodie_file_name                                 | slr_config_poc.config_plcy_type_nm  | slr_config_poc.prod_hrchy_tmpl_nm  | slr_config_poc.prod_hrchy_tmpl_val  | slr_config_poc.attr_nm  | slr_config_poc.attr_val  | slr_config_poc.eff_end_ts  | slr_config_poc.actv_ind  | slr_config_poc.upd_ts  | slr_config_poc.cre_user  | slr_config_poc.cre_ts  | slr_config_poc.upd_user  | slr_config_poc.op_cmpny_cd  | slr_config_poc.geo_region_cd  | slr_config_poc.src_rcv_ts  | slr_config_poc.tenant_org_id  | slr_config_poc.eff_start_ts  | slr_config_poc.slr_org_id  |      slr_config_poc.offr_key      | slr_config_poc.cre_dt  |
+-------------------------------------+--------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------+---------------------------------------------------------------------------+-------------------------------------+------------------------------------+-------------------------------------+-------------------------+--------------------------+----------------------------+--------------------------+------------------------+--------------------------+------------------------+--------------------------+-----------------------------+-------------------------------+----------------------------+-------------------------------+------------------------------+----------------------------+-----------------------------------+------------------------+
| 20220203101320                      | 20220203101320_8_1                   | slr_org_id:101053954,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:AA,eff_end_ts:9999-12-31 15:59:59 | cre_dt=2021-07-02                      | 056a1a8b-cb8c-4e8b-84da-ef54e398576c-0_8-189-26832_20220203101320.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | returnCenterAlias       | AA                       | 9999-12-31 15:59:59        | 1                        |                        | RCP-BULK-OVERRIDE        | 2021-07-02 01:05:02    |                          |                             |                               |                            | 4571                          | 2021-07-02 03:07:59          | 101053954                  | 861685C0AE8A4BFB95B23269E805A64D  | 2021-07-02             |
| 20220203101320                      | 20220203101320_6_1                   | slr_org_id:101043447,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:GG,eff_end_ts:9999-12-31 15:59:59 | cre_dt=2021-10-31                      | 9c08d9d4-cc45-43b3-a090-f7f9dfc37ee9-0_6-189-26830_20220203101320.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | returnCenterAlias       | GG                       | 9999-12-31 15:59:59        | 1                        |                        | RCP-BULK-OVERRIDE        | 2021-10-31 01:05:28    |                          |                             |                               |                            | 4571                          | 2021-10-30 08:27:52          | 101043447                  | 9983664A4435459AA9266999FF57A15E  | 2021-10-31             |
| 20220203101320                      | 20220203101320_0_1                   | slr_org_id:101043490,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:GT,eff_end_ts:9999-12-31 15:59:59 | cre_dt=2021-05-06                      | 7d601557-4d09-493b-be62-e35502c586b6-0_0-177-26824_20220203101320.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | returnCenterAlias       | GT                       | 9999-12-31 15:59:59        | 1                        |                        | RCP-BULK-OVERRIDE        | 2021-05-06 00:32:45    |                          |                             |                               |                            | 4571                          | 2020-10-30 07:56:41          | 101043490                  | 516457803CCD4F769C6109903831B9BA  | 2021-05-06             |
| 20220203101320                      | 20220203101320_5_1                   | slr_org_id:101072853,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:GT,eff_end_ts:9999-12-31 15:59:59 | cre_dt=2021-12-28                      | 9a8b5aa9-67bd-4aed-8e6d-1a71d2def734-0_5-189-26829_20220203101320.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | returnCenterAlias       | GT                       | 9999-12-31 15:59:59        | 1                        |                        | RCP-BULK-OVERRIDE        | 2021-12-28 01:05:16    |                          |                             |                               |                            | 4571                          | 2021-12-27 11:36:41          | 101072853                  | C313F674D039460CAB128108252C5B9E  | 2021-12-28             |
| 20220203101320                      | 20220203101320_4_1                   | slr_org_id:101087594,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:GT,eff_end_ts:9999-12-31 15:59:59 | cre_dt=2021-12-29                      | f47c974a-aca2-4f2a-b290-cb9062157924-0_4-183-26828_20220203101320.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | returnCenterAlias       | GT                       | 9999-12-31 15:59:59        | 1                        |                        | RCP-BULK-OVERRIDE        | 2021-12-29 01:05:23    |                          |                             |                               |                            | 4571                          | 2021-12-28 07:31:44          | 101087594                  | C58F5E0CCC9B4867B8A3D92BD9446835  | 2021-12-29             |
| 20220203101320                      | 20220203101320_1_1                   | slr_org_id:101087560,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:gt,eff_end_ts:9999-12-31 15:59:59 | cre_dt=2022-01-28                      | 5efec7c2-5743-4897-b337-68eb5ee0dfbb-0_1-183-26825_20220203101320.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | returnCenterAlias       | gt                       | 9999-12-31 15:59:59        | 1                        |                        | RCP-BULK-OVERRIDE        | 2022-01-28 01:06:42    |                          |                             |                               |                            | 4571                          | 2022-01-27 08:58:57          | 101087560                  | 2593B38B567149A2AC03451174392353  | 2022-01-28             |
| 20220203101320                      | 20220203101320_7_1                   | slr_org_id:101044619,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:GG,eff_end_ts:9999-12-31 15:59:59 | cre_dt=2021-11-10                      | 839c2f39-4f58-451d-b542-95b8cbe96144-0_7-189-26831_20220203101320.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | returnCenterAlias       | GG                       | 9999-12-31 15:59:59        | 1                        |                        | RCP-BULK-OVERRIDE        | 2021-11-10 01:05:55    |                          |                             |                               |                            | 4571                          | 2021-11-09 10:00:22          | 101044619                  | 798A19DA29FB4584B956305FDC37E319  | 2021-11-10             |
| 20220203101633                      | 20220203101633_2_1                   | slr_org_id:2605,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:F,eff_end_ts:2022-02-02 15:58:19       | cre_dt=2021-08-20                      | d23bb86a-01ae-47c1-9e65-57383ef08a3d-0_2-279-40366_20220203101633.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | returnCenterAlias       | F                        | 2022-02-02 15:58:19        | 0                        | 2021-08-20 01:08:54    | RCP-BULK-OVERRIDE        | 2021-08-20 01:08:54    | RCP-BULK-OVERRIDE        |                             |                               | 2021-08-19 15:58:20        | 4571                          | 2021-08-19 15:58:20          | 2605                       | Category                          | 2021-08-20             |
| 20220203101633                      | 20220203101633_2_2                   | slr_org_id:2605,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:12,eff_end_ts:9999-12-31 23:59:59      | cre_dt=2021-08-20                      | d23bb86a-01ae-47c1-9e65-57383ef08a3d-0_2-279-40366_20220203101633.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | returnCenterAlias       | 12                       | 9999-12-31 23:59:59        | 1                        | 2021-08-20 01:08:54    | RCP-BULK-OVERRIDE        | 2021-08-20 01:08:54    | RCP-BULK-OVERRIDE        |                             |                               | 2022-02-02 15:58:20        | 4571                          | 2022-02-02 15:58:20          | 2605                       | Category                          | 2021-08-20             |
| 20220203101633                      | 20220203101633_0_2                   | slr_org_id:9999,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:shippingFee,attr_val:99,eff_end_ts:9999-12-31 23:59:59            | cre_dt=2022-02-01                      | a9fa0383-dad8-46b5-9b9f-670d00449707-0_0-270-40364_20220203101633.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | shippingFee             | 99                       | 9999-12-31 23:59:59        | 1                        |                        | RCP-BULK-OVERRIDE        | 2022-02-01 18:21:11    |                          |                             |                               | 2022-01-27 08:17:11        | 4571                          | 2022-01-27 08:17:11          | 9999                       | Category                          | 2022-02-01             |
| 20220203101320                      | 20220203101320_3_2                   | slr_org_id:339,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,attr_val:MO,eff_end_ts:9999-12-31 15:59:59       | cre_dt=2019-06-11                      | 06596953-6dcc-4b9a-b03e-c8e64d5bb9e4-0_3-183-26827_20220203101320.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | returnCenterAlias       | MO                       | 9999-12-31 15:59:59        | 1                        |                        | RCP-BULK-OVERRIDE        | 2019-06-11 11:23:14    |                          |                             |                               |                            | 4571                          | 2018-11-12 11:43:29          | 339                        | DAF856738A63423592A3CD4A544115EA  | 2019-06-11             |
| 20220203101633                      | 20220203101633_1_1                   | slr_org_id:2354,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:shippingFee,attr_val:24,eff_end_ts:9999-12-31 23:59:59            | cre_dt=2019-06-11                      | 06596953-6dcc-4b9a-b03e-c8e64d5bb9e4-0_1-279-40365_20220203101633.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | shippingFee             | 24                       | 9999-12-31 23:59:59        | 1                        | 2019-06-11 11:22:29    | RCP-BULK-OVERRIDE        | 2019-06-11 11:22:29    | RCP-BULK-OVERRIDE        |                             |                               | 2020-02-02 18:23:01        | 4571                          | 2020-02-02 18:23:01          | 2354                       | Category                          | 2019-06-11             |
| 20220203101633                      | 20220203101633_1_2                   | slr_org_id:2354,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:shippingFee,attr_val:99,eff_end_ts:2020-02-02 18:23:00            | cre_dt=2019-06-11                      | 06596953-6dcc-4b9a-b03e-c8e64d5bb9e4-0_1-279-40365_20220203101633.parquet | RETURN_POLICY                       | RCP-BULK-OVERRIDE                  | RCP-BULK-OVERRIDE                   | shippingFee             | 99                       | 2020-02-02 18:23:00        | 0                        | 2019-06-11 11:22:29    | RCP-BULK-OVERRIDE        | 2019-06-11 11:22:29    | RCP-BULK-OVERRIDE        |                             |                               | 2018-10-31 18:23:01        | 4571                          | 2018-10-31 18:23:01          | 2354                       | Category                          | 2019-06-11             |
+-------------------------------------+--------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------+---------------------------------------------------------------------------+-------------------------------------+------------------------------------+-------------------------------------+-------------------------+--------------------------+----------------------------+--------------------------+------------------------+--------------------------+------------------------+--------------------------+-----------------------------+-------------------------------+----------------------------+-------------------------------+------------------------------+----------------------------+-----------------------------------+------------------------+
Approach 2 (without delete operation):

spark-shell \
--packages org.apache.hudi:hudi-spark-bundle_2.12:0.9.0,org.apache.spark:spark-avro_2.12:2.4.7,org.apache.avro:avro:1.8.2 \
--conf "spark.serializer=org.apache.spark.serializer.KryoSerializer" \
--conf 'spark.sql.extensions=org.apache.spark.sql.hudi.HoodieSparkSessionExtension' \
--conf "spark.sql.hive.convertMetastoreParquet=false"
 
import org.apache.spark.sql.SaveMode._
import org.apache.hudi.DataSourceWriteOptions._
import org.apache.hudi.DataSourceWriteOptions
import org.apache.hudi.DataSourceReadOptions._
import org.apache.hudi.DataSourceReadOptions
import org.apache.hudi.QuickstartUtils._
import org.apache.spark.sql.DataFrame
 
 
####################################
##first time data insert:
val srcDf = spark.sql("select * from raw_wmt_ww_fin_rtn_mb_dl_secure.raw_slr_config_poc")
       
srcDf.write.format("org.apache.hudi")
    .option(TABLE_TYPE_OPT_KEY, "COPY_ON_WRITE")
    .option("hoodie.datasource.write.keygenerator.class","org.apache.hudi.keygen.ComplexKeyGenerator")
    .option(RECORDKEY_FIELD_OPT_KEY, "slr_org_id ,config_plcy_type_nm,prod_hrchy_tmpl_nm,prod_hrchy_tmpl_val,attr_nm,eff_end_ts")
    .option("hoodie.datasource.hive_sync.support_timestamp","true")
    .option(PRECOMBINE_FIELD_OPT_KEY, "eff_start_ts")
    .option("hoodie.table.name","SLR_CONFIG_POC")
    .option(DataSourceWriteOptions.HIVE_DATABASE_OPT_KEY, "stg_wmt_ww_fin_rtn_mb_dl_secure")
    .option(DataSourceWriteOptions.HIVE_TABLE_OPT_KEY, "SLR_CONFIG_POC")
    .option(OPERATION_OPT_KEY, UPSERT_OPERATION_OPT_VAL)
    .option(DataSourceWriteOptions.HIVE_STYLE_PARTITIONING_OPT_KEY, "true")
    .option(PARTITIONPATH_FIELD_OPT_KEY, "actv_ind")
    .mode(Append)
    .save(s"gs://950c9f02a16a88138930efe39d0aa87c64d2948b5d55ee35c780c2369717f7/stg_wmt_ww_fin_rtn_mb_dl_secure/SLR_CONFIG_POC")
 
####################################
 
val SlrConfig = spark.read.format("org.apache.hudi").load("gs://950c9f02a16a88138930efe39d0aa87c64d2948b5d55ee35c780c2369717f7/stg_wmt_ww_fin_rtn_mb_dl_secure/SLR_CONFIG_POC")
 
SlrConfig.show(false)
 
+-------------------+--------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+--------------------------------------------------------------------------+-------------------+------------------+-------------------+-----------------+--------+-------------------+------+-----------------+-------------------+--------+-----------+-------------+----------+-------------+-------------------+----------+--------------------------------+----------+--------+
|_hoodie_commit_time|_hoodie_commit_seqno|_hoodie_record_key                                                                                                                                                                   |_hoodie_partition_path|_hoodie_file_name                                                         |config_plcy_type_nm|prod_hrchy_tmpl_nm|prod_hrchy_tmpl_val|attr_nm          |attr_val|eff_end_ts         |upd_ts|cre_user         |cre_ts             |upd_user|op_cmpny_cd|geo_region_cd|src_rcv_ts|tenant_org_id|eff_start_ts       |slr_org_id|offr_key                        |cre_dt    |actv_ind|
+-------------------+--------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+--------------------------------------------------------------------------+-------------------+------------------+-------------------+-----------------+--------+-------------------+------+-----------------+-------------------+--------+-----------+-------------+----------+-------------+-------------------+----------+--------------------------------+----------+--------+
|20220209074223     |20220209074223_0_1  |slr_org_id:2354,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:shippingFee,eff_end_ts:9999-12-31 23:59:59      |actv_ind=1            |2ed5abf1-540f-4081-9bf2-2fd10ab3ad7f-0_0-411-102819_20220209074223.parquet|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |shippingFee      |99      |9999-12-31 23:59:59|      |RCP-BULK-OVERRIDE|2019-06-11 11:22:29|        |           |             |          |4571         |2018-10-31 18:23:01|2354      |0FAF8812717F4289B5D2ACE9AC4E207B|2019-06-11|1       |
|20220209074223     |20220209074223_0_2  |slr_org_id:2605,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,eff_end_ts:9999-12-31 23:59:59|actv_ind=1            |2ed5abf1-540f-4081-9bf2-2fd10ab3ad7f-0_0-411-102819_20220209074223.parquet|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |returnCenterAlias|F       |9999-12-31 23:59:59|      |RCP-BULK-OVERRIDE|2021-08-20 01:08:54|        |           |             |          |4571         |2021-08-19 15:58:20|2605      |199104919BC7408D878C598554A65348|2021-08-20|1       |
+-------------------+--------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+--------------------------------------------------------------------------+-------------------+------------------+-------------------+-----------------+--------+-------------------+------+-----------------+-------------------+--------+-----------+-------------+----------+-------------+-------------------+----------+--------------------------------+----------+--------+
 
SlrConfig.createOrReplaceTempView("SlrConfig")
 
spark.sql("select * from stg_wmt_ww_fin_rtn_mb_dl_secure.stg_rcp_slr_config_poc").show
+------+------------+--------+-------------------+-------------+-----------------+-----------------+-----------------+-----+----------+-----------------+-------------------+-------------------+
|martid|producername|sellerid|          timestamp|   configtype|      keytemplate|        policykey|             name|value|change_ind|         cre_user|             cre_ts|         raw_cre_dt|
+------+------------+--------+-------------------+-------------+-----------------+-----------------+-----------------+-----+----------+-----------------+-------------------+-------------------+
|     0|            |    2605|2021-11-05 11:17:22|RETURN_POLICY|RCP-BULK-OVERRIDE|RCP-BULK-OVERRIDE|returnCenterAlias|12345|         U|RCP-BULK-OVERRIDE|2021-11-06 21:22:15|2021-11-06 21:22:15|
+------+------------+--------+-------------------+-------------+-----------------+-----------------+-----------------+-----+----------+-----------------+-------------------+-------------------+
 
val newRecDf=spark.sql("""select
    config_plcy_type_nm
    ,prod_hrchy_tmpl_nm
    ,prod_hrchy_tmpl_val
    ,attr_nm
    ,attr_val
    , eff_start_ts
    ,eff_end_ts
    ,actv_ind
    ,tenant_org_id
    ,slr_org_id
    ,offr_key
    ,src_rcv_ts
    ,cre_user
    ,cre_ts
    ,cre_dt
    ,upd_ts
    ,upd_user
    ,op_cmpny_cd
    ,geo_region_cd from
    (select
     stg.configtype     as config_plcy_type_nm
    ,stg.keytemplate   as prod_hrchy_tmpl_nm
    ,stg.policykey  as prod_hrchy_tmpl_val
    ,stg.name       as attr_nm
    ,stg.value     as attr_val
    ,stg.timestamp as eff_start_ts
    ,'9999-12-31 23:59:59' as eff_end_ts
    ,'1'  as actv_ind
    ,'4571' as tenant_org_id
    ,stg.sellerid as slr_org_id
    ,'Category' as offr_key
    ,stg.timestamp as src_rcv_ts
    ,stg.cre_user
    ,stg.cre_ts as cre_ts
    ,cast(cast(cast(stg.cre_ts as timestamp) as date) as string) cre_dt
    ,row_number() over(partition by stg. sellerid ,stg.configtype ,stg.keytemplate ,stg.policykey,stg.name  order by timestamp desc) row_num
    ,'' as upd_ts
    ,'' as upd_user
    ,'' as op_cmpny_cd
    ,'' as geo_region_cd
    from  stg_wmt_ww_fin_rtn_mb_dl_secure.stg_rcp_slr_config_poc stg
    left outer join slrconfig tgt
    on  cast( stg.sellerid as integer)  = cast(tgt.slr_org_id as integer)
    and stg.configtype  = tgt.config_plcy_type_nm
    and stg.keytemplate =  tgt.prod_hrchy_tmpl_nm
    and stg.policykey  = tgt.prod_hrchy_tmpl_val
    and stg.name = tgt.attr_nm
    and tgt. actv_ind =1 and tgt.offr_key  ='Category'
    where change_ind ='I' and coalesce(martid,'1') = '0' and tgt.slr_org_id is null 
    and  cast(stg.sellerid as integer) is not null) src
    where row_num=1""")
 
 
val innerJoinDf=spark.sql("""
      SELECT * from (
      SELECT
       stg.configtype     as stg_config_plcy_type_nm
      ,stg.keytemplate   as stg_prod_hrchy_tmpl_nm
      ,stg.policykey  as stg_prod_hrchy_tmpl_val
      ,stg.name       as stg_attr_nm
      ,stg.value     as stg_attr_val
      ,stg.timestamp as stg_eff_start_ts
      ,stg.sellerid as stg_slr_org_id
      ,stg.cre_user as stg_cre_user
      ,stg.cre_ts as stg_cre_ts
 
      ,tgt.config_plcy_type_nm  as tgt_config_plcy_type_nm
      ,tgt.prod_hrchy_tmpl_nm as tgt_prod_hrchy_tmpl_nm
      ,tgt.prod_hrchy_tmpl_val as tgt_prod_hrchy_tmpl_val
      ,tgt.attr_nm as tgt_attr_nm
      ,tgt.attr_val as tgt_attr_val
      ,tgt.eff_start_ts as tgt_eff_start_ts
      ,tgt.eff_end_ts as tgt_eff_end_ts
      ,tgt.slr_org_id as tgt_slr_org_id
      ,tgt.cre_user as tgt_cre_user
      ,tgt.cre_ts as tgt_cre_ts
 
      ,row_number() over(partition by stg. sellerid ,stg.configtype ,stg.keytemplate ,stg.policykey,stg.name,stg.value order by stg.timestamp desc) row_num
      from  stg_wmt_ww_fin_rtn_mb_dl_secure.stg_rcp_slr_config_poc stg
      inner join slrconfig tgt
      on cast( stg.sellerid as integer)  = cast(tgt.slr_org_id as integer)
      and stg.configtype  = tgt.config_plcy_type_nm
      and stg.keytemplate =  tgt.prod_hrchy_tmpl_nm
      and stg.policykey  = tgt.prod_hrchy_tmpl_val
      and stg.name  = tgt.attr_nm
      and tgt. actv_ind = 1 /* and  tgt.offr_key  ='Category' */
      where stg.change_ind ='U' and coalesce(stg.martid,'1') = '0' 
      and  cast ( stg.`timestamp` as timestamp) >  cast(tgt.eff_start_ts as timestamp)
      and  cast(stg.sellerid as integer) is not null)
      where row_num=1""")
 
 
 
innerJoinDf.createOrReplaceTempView("updateRecordTable")
 
 
val updActiveRecDf=spark.sql(""" 
     SELECT
       stg_config_plcy_type_nm as config_plcy_type_nm
      ,stg_prod_hrchy_tmpl_nm as prod_hrchy_tmpl_nm
      ,stg_prod_hrchy_tmpl_val as prod_hrchy_tmpl_val
      ,stg_attr_nm as attr_nm
      ,stg_attr_val as attr_val
      ,stg_eff_start_ts as eff_start_ts
      ,'9999-12-31 23:59:59' as eff_end_ts
      ,'1'  as actv_ind
      , '4571' as tenant_org_id
      ,stg_slr_org_id as slr_org_id
      ,'Category' as offr_key
      ,stg_eff_start_ts as src_rcv_ts
      ,stg_cre_user as cre_user
      ,stg_cre_ts as cre_ts
      ,cast(cast(cast(tgt_cre_ts as timestamp) as date) as string) cre_dt
      ,stg_cre_ts as upd_ts
      ,stg_cre_user as upd_user
      ,'' as op_cmpny_cd
      ,'' as geo_region_cd
     from updaterecordtable""")
 
 
val updInactiveRecDf=
spark.sql("""
     SELECT
       tgt_config_plcy_type_nm as config_plcy_type_nm
      ,tgt_prod_hrchy_tmpl_nm as prod_hrchy_tmpl_nm
      ,tgt_prod_hrchy_tmpl_val as prod_hrchy_tmpl_val
      ,tgt_attr_nm as attr_nm
      ,tgt_attr_val as attr_val
      ,tgt_eff_start_ts as eff_start_ts
      ,cast(cast(stg_eff_start_ts as timestamp) + interval -1 seconds as string) as eff_end_ts
      ,'0'  as actv_ind
      ,'4571' as tenant_org_id
      ,tgt_slr_org_id as slr_org_id
      ,'Category' as offr_key
      ,tgt_eff_start_ts as src_rcv_ts
      ,tgt_cre_user as cre_user
      ,tgt_cre_ts as cre_ts
      ,cast(cast(cast(tgt_cre_ts as timestamp) as date) as string) cre_dt
      ,stg_cre_ts as upd_ts
      ,stg_cre_user as upd_user
      ,'' as op_cmpny_cd
      ,'' as geo_region_cd
     from updaterecordtable""")
 
 
val insUdpRec=newRecDf.union(updActiveRecDf).union(updInactiveRecDf)
 
insUdpRec.show(false)
+-------------------+------------------+-------------------+-----------------+--------+-------------------+-------------------+--------+-------------+----------+--------+-------------------+-----------------+-------------------+----------+-------------------+-----------------+-----------+-------------+
|config_plcy_type_nm|prod_hrchy_tmpl_nm|prod_hrchy_tmpl_val|attr_nm          |attr_val|eff_start_ts       |eff_end_ts         |actv_ind|tenant_org_id|slr_org_id|offr_key|src_rcv_ts         |cre_user         |cre_ts             |cre_dt    |upd_ts             |upd_user         |op_cmpny_cd|geo_region_cd|
+-------------------+------------------+-------------------+-----------------+--------+-------------------+-------------------+--------+-------------+----------+--------+-------------------+-----------------+-------------------+----------+-------------------+-----------------+-----------+-------------+
|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |returnCenterAlias|12345   |2021-11-05 11:17:22|9999-12-31 23:59:59|1       |4571         |2605      |Category|2021-11-05 11:17:22|RCP-BULK-OVERRIDE|2021-11-06 21:22:15|2021-08-20|2021-11-06 21:22:15|RCP-BULK-OVERRIDE|           |             |
|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |returnCenterAlias|F       |2021-08-19 15:58:20|2021-11-05 11:17:21|0       |4571         |2605      |Category|2021-08-19 15:58:20|RCP-BULK-OVERRIDE|2021-08-20 01:08:54|2021-08-20|2021-11-06 21:22:15|RCP-BULK-OVERRIDE|           |             |
+-------------------+------------------+-------------------+-----------------+--------+-------------------+-------------------+--------+-------------+----------+--------+-------------------+-----------------+-------------------+----------+-------------------+-----------------+-----------+-------------+
 
 
insUdpRec.write.format("org.apache.hudi")
    .option(TABLE_TYPE_OPT_KEY, "COPY_ON_WRITE")
    .option("hoodie.datasource.write.keygenerator.class","org.apache.hudi.keygen.ComplexKeyGenerator")
    .option(RECORDKEY_FIELD_OPT_KEY, "slr_org_id ,config_plcy_type_nm,prod_hrchy_tmpl_nm,prod_hrchy_tmpl_val,attr_nm,eff_end_ts")
    .option(PRECOMBINE_FIELD_OPT_KEY, "eff_start_ts")
    .option("hoodie.table.name","SLR_CONFIG_POC")
    .option(DataSourceWriteOptions.HIVE_DATABASE_OPT_KEY, "stg_wmt_ww_fin_rtn_mb_dl_secure")
    .option(DataSourceWriteOptions.HIVE_TABLE_OPT_KEY, "SLR_CONFIG_POC")
    .option(OPERATION_OPT_KEY, UPSERT_OPERATION_OPT_VAL)
    .option(DataSourceWriteOptions.HIVE_STYLE_PARTITIONING_OPT_KEY, "true")
    .option(PARTITIONPATH_FIELD_OPT_KEY, "actv_ind")
    .mode(Append)
    .save(s"gs://950c9f02a16a88138930efe39d0aa87c64d2948b5d55ee35c780c2369717f7/stg_wmt_ww_fin_rtn_mb_dl_secure/SLR_CONFIG_POC")
 
+-------------------+--------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+--------------------------------------------------------------------------+-------------------+------------------+-------------------+-----------------+--------+-------------------+-------------------+-------------+----------+--------------------------------+-------------------+-----------------+-------------------+----------+-------------------+-----------------+-----------+-------------+--------+
|_hoodie_commit_time|_hoodie_commit_seqno|_hoodie_record_key                                                                                                                                                                   |_hoodie_partition_path|_hoodie_file_name                                                         |config_plcy_type_nm|prod_hrchy_tmpl_nm|prod_hrchy_tmpl_val|attr_nm          |attr_val|eff_start_ts       |eff_end_ts         |tenant_org_id|slr_org_id|offr_key                        |src_rcv_ts         |cre_user         |cre_ts             |cre_dt    |upd_ts             |upd_user         |op_cmpny_cd|geo_region_cd|actv_ind|
+-------------------+--------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+--------------------------------------------------------------------------+-------------------+------------------+-------------------+-----------------+--------+-------------------+-------------------+-------------+----------+--------------------------------+-------------------+-----------------+-------------------+----------+-------------------+-----------------+-----------+-------------+--------+
|20220209074508     |20220209074508_1_3  |slr_org_id:2605,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,eff_end_ts:2021-11-05 11:17:21|actv_ind=0            |19d08fb7-fe76-4a01-b563-136e754d8040-0_1-493-117554_20220209074508.parquet|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |returnCenterAlias|F       |2021-08-19 15:58:20|2021-11-05 11:17:21|4571         |2605      |Category                        |2021-08-19 15:58:20|RCP-BULK-OVERRIDE|2021-08-20 01:08:54|2021-08-20|2021-11-06 21:22:15|RCP-BULK-OVERRIDE|           |             |0       |
|20220209074223     |20220209074223_0_1  |slr_org_id:2354,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:shippingFee,eff_end_ts:9999-12-31 23:59:59      |actv_ind=1            |2ed5abf1-540f-4081-9bf2-2fd10ab3ad7f-0_0-411-102819_20220209074223.parquet|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |shippingFee      |99      |2018-10-31 18:23:01|9999-12-31 23:59:59|4571         |2354      |0FAF8812717F4289B5D2ACE9AC4E207B|                   |RCP-BULK-OVERRIDE|2019-06-11 11:22:29|2019-06-11|                   |                 |           |             |1       |
|20220209074508     |20220209074508_0_1  |slr_org_id:2605,config_plcy_type_nm:RETURN_POLICY,prod_hrchy_tmpl_nm:RCP-BULK-OVERRIDE,prod_hrchy_tmpl_val:RCP-BULK-OVERRIDE,attr_nm:returnCenterAlias,eff_end_ts:9999-12-31 23:59:59|actv_ind=1            |2ed5abf1-540f-4081-9bf2-2fd10ab3ad7f-0_0-484-117553_20220209074508.parquet|RETURN_POLICY      |RCP-BULK-OVERRIDE |RCP-BULK-OVERRIDE  |returnCenterAlias|12345   |2021-11-05 11:17:22|9999-12-31 23:59:59|4571         |2605      |Category                        |2021-11-05 11:17:22|RCP-BULK-OVERRIDE|2021-11-06 21:22:15|2021-08-20|2021-11-06 21:22:15|RCP-BULK-OVERRIDE|           |             |1       |
+-------------------+--------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+--------------------------------------------------------------------------+-------------------+------------------+-------------------+-----------------+--------+-------------------+-------------------+-------------+----------+--------------------------------+-------------------+-----------------+-------------------+----------+-------------------+-----------------+-----------+-------------+--------+


Limitations and open issues
Complexkeygenerattor does not support non partitioned HUDI table
Reference ticket from HUDI :  https://issues.apache.org/jira/browse/HUDI-1053
          Workaround logic : If we wanted to use multiple key combination in RECORDKEY_FIELD_OPT_KEY, HUDI table has to be partitioned 

Failed to read timestamp column  from HIVE terminal even when HIVE_SUPPORT_TIMESTAMP is enabled
Reference ticket from HUDI :
https://github.com/apache/hudi/issues/2544
https://issues.apache.org/jira/browse/HUDI-1736
https://github.com/apache/hudi/pull/3391

          Workaround logic : Timestamp columns were kept as String in HUDI- hive table and Dataframe cast operation can be applied.



